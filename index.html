<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladue, MO Weather Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .weather-section {
            background: #0f3460;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #1a5490;
            margin-bottom: 20px;
        }

        .section-title {
            color: #e94560;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a5490;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .timeline-label {
            color: #a8b2d1;
            font-size: 0.9em;
            font-weight: 600;
        }

        .timeline-label.today {
            color: #e94560;
            font-size: 1em;
        }

        .chart-container-wide {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 20px;
            background: #16213e;
            border-radius: 15px;
            border: 1px solid #1a5490;
            overflow-x: auto;
        }

        .line-chart {
            width: 100%;
            height: 300px;
            margin-bottom: 10px;
        }

        .data-point {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .data-point:hover {
            r: 7;
            filter: brightness(1.5);
        }

        .current-point {
            filter: drop-shadow(0 0 8px #e94560);
        }

        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0%, 100% { 
                r: 12; 
                opacity: 0.3; 
            }
            50% { 
                r: 16; 
                opacity: 0; 
            }
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            padding: 0 10px;
        }

        .day-label {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 50px;
        }

        .label-temp {
            color: #00d9ff;
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .label-day {
            color: #a8b2d1;
            font-size: 0.75em;
            line-height: 1.3;
            margin-bottom: 5px;
        }

        .label-icon {
            color: #00d9ff;
            font-size: 0.7em;
        }

        .past-label .label-temp,
        .past-label .label-icon {
            color: #a8b2d1;
            opacity: 0.7;
        }

        .current-label .label-temp {
            color: #e94560;
            font-size: 1em;
        }

        .current-label .label-day {
            color: #e94560;
            font-weight: bold;
            font-size: 0.8em;
        }

        .current-label .label-icon {
            color: #e94560;
            font-weight: bold;
        }

        .map-container {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #1a5490;
        }

        #weatherMap {
            width: 100%;
            height: 450px;
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a8b2d1;
            font-size: 1.2em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e94560;
            font-size: 1.1em;
        }

        .last-updated {
            text-align: center;
            color: #a8b2d1;
            font-size: 0.9em;
            margin-top: 10px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .section-title {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 15-Day Weather Timeline -->
        <div class="weather-section">
            <div class="section-title">üå§Ô∏è Ladue, MO - 15-Day Weather Timeline (Live Data)</div>
            
            <div id="loadingMessage" class="loading">
                Loading live weather data...
            </div>

            <div id="errorMessage" class="error" style="display: none;">
                Unable to load weather data. Please try again later.
            </div>

            <div id="weatherChart" style="display: none;">
                <div class="timeline-labels">
                    <span class="timeline-label past">‚Üê Past 7 Days</span>
                    <span class="timeline-label today">Today</span>
                    <span class="timeline-label future">Next 7 Days ‚Üí</span>
                </div>
                <div class="chart-container-wide">
                    <svg class="line-chart" id="weatherSvg" viewBox="0 0 1000 300" preserveAspectRatio="none">
                    </svg>
                    
                    <div class="chart-labels" id="chartLabels">
                    </div>
                </div>
                <div class="last-updated" id="lastUpdated"></div>
            </div>
        </div>

        <!-- Map View Section -->
        <div class="weather-section">
            <div class="section-title">üìç Ladue, MO - Precipitation Map</div>
            <div class="map-container">
                <div id="weatherMap"></div>
                <div style="margin-top: 10px; color: #a8b2d1; font-size: 0.9em;">
                    <strong>Map Legend:</strong> Blue overlay shows precipitation. Click to zoom/pan.
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Ladue, MO coordinates
        const LATITUDE = 38.6495;
        const LONGITUDE = -90.3784;

        let weatherData = null;
        let weatherMap = null;

        // Fetch weather data from Open-Meteo API
        async function fetchWeatherData() {
            try {
                // Get current date
                const today = new Date();
                const past7Days = new Date(today);
                past7Days.setDate(past7Days.getDate() - 7);

                const formatDate = (date) => {
                    return date.toISOString().split('T')[0];
                };

                // Fetch historical and forecast data
                const historicalResponse = await fetch(
                    `https://archive-api.open-meteo.com/v1/archive?latitude=${LATITUDE}&longitude=${LONGITUDE}&start_date=${formatDate(past7Days)}&end_date=${formatDate(today)}&daily=temperature_2m_max,precipitation_probability_max,weather_code&temperature_unit=fahrenheit&timezone=America/Chicago`
                );

                const forecastResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&daily=temperature_2m_max,precipitation_probability_max,weather_code&temperature_unit=fahrenheit&timezone=America/Chicago&forecast_days=8`
                );

                if (!historicalResponse.ok || !forecastResponse.ok) {
                    throw new Error('API request failed');
                }

                const historicalData = await historicalResponse.json();
                const forecastData = await forecastResponse.json();

                // Combine the data
                const combinedData = {
                    historical: historicalData.daily,
                    forecast: forecastData.daily
                };

                weatherData = combinedData;
                renderWeatherChart();
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('weatherChart').style.display = 'block';

            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        // Convert weather code to emoji and description
        function getWeatherEmoji(code) {
            const weatherCodes = {
                0: { emoji: '‚òÄÔ∏è', desc: 'Clear' },
                1: { emoji: 'üå§Ô∏è', desc: 'Mainly Clear' },
                2: { emoji: '‚õÖ', desc: 'Partly Cloudy' },
                3: { emoji: '‚òÅÔ∏è', desc: 'Cloudy' },
                45: { emoji: 'üå´Ô∏è', desc: 'Foggy' },
                48: { emoji: 'üå´Ô∏è', desc: 'Foggy' },
                51: { emoji: 'üå¶Ô∏è', desc: 'Light Drizzle' },
                53: { emoji: 'üå¶Ô∏è', desc: 'Drizzle' },
                55: { emoji: 'üåßÔ∏è', desc: 'Heavy Drizzle' },
                61: { emoji: 'üåßÔ∏è', desc: 'Light Rain' },
                63: { emoji: 'üåßÔ∏è', desc: 'Rain' },
                65: { emoji: 'üåßÔ∏è', desc: 'Heavy Rain' },
                71: { emoji: 'üå®Ô∏è', desc: 'Light Snow' },
                73: { emoji: 'üå®Ô∏è', desc: 'Snow' },
                75: { emoji: 'üå®Ô∏è', desc: 'Heavy Snow' },
                77: { emoji: 'üå®Ô∏è', desc: 'Snow Grains' },
                80: { emoji: 'üå¶Ô∏è', desc: 'Light Showers' },
                81: { emoji: 'üåßÔ∏è', desc: 'Showers' },
                82: { emoji: 'üåßÔ∏è', desc: 'Heavy Showers' },
                85: { emoji: 'üå®Ô∏è', desc: 'Light Snow Showers' },
                86: { emoji: 'üå®Ô∏è', desc: 'Snow Showers' },
                95: { emoji: '‚õàÔ∏è', desc: 'Thunderstorm' },
                96: { emoji: '‚õàÔ∏è', desc: 'Thunderstorm with Hail' },
                99: { emoji: '‚õàÔ∏è', desc: 'Severe Thunderstorm' }
            };
            return weatherCodes[code] || { emoji: 'üå§Ô∏è', desc: 'Unknown' };
        }

        function renderWeatherChart() {
            if (!weatherData) return;

            const svg = document.getElementById('weatherSvg');
            const labelsContainer = document.getElementById('chartLabels');

            // Combine all temperatures for scaling
            const allTemps = [
                ...weatherData.historical.temperature_2m_max.slice(-7),
                ...weatherData.forecast.temperature_2m_max.slice(0, 8)
            ];

            const minTemp = Math.min(...allTemps);
            const maxTemp = Math.max(...allTemps);
            const tempRange = maxTemp - minTemp;

            // Calculate Y positions (inverted for SVG)
            const getY = (temp) => {
                const normalized = (temp - minTemp) / tempRange;
                return 250 - (normalized * 200); // 50px margin top/bottom
            };

            // Generate path and points
            let pathData = '';
            let points = [];
            const spacing = 1000 / 14; // 15 points

            allTemps.forEach((temp, index) => {
                const x = index * spacing + spacing / 2;
                const y = getY(temp);
                points.push({ x, y, temp, index });
                
                if (index === 0) {
                    pathData = `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
            });

            // Clear SVG
            svg.innerHTML = '';

            // Add grid lines
            for (let i = 0; i < 4; i++) {
                const y = 75 * i + 25;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '0');
                line.setAttribute('y1', y);
                line.setAttribute('x2', '1000');
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#1a5490');
                line.setAttribute('stroke-width', '1');
                line.setAttribute('opacity', '0.3');
                svg.appendChild(line);
            }

            // Add gradient definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'lineGradient');
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('x2', '100%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', 'stop-color:#4a5568');
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '46%');
            stop2.setAttribute('style', 'stop-color:#00d9ff');
            
            const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop3.setAttribute('offset', '50%');
            stop3.setAttribute('style', 'stop-color:#e94560');
            
            const stop4 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop4.setAttribute('offset', '54%');
            stop4.setAttribute('style', 'stop-color:#00d9ff');
            
            const stop5 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop5.setAttribute('offset', '100%');
            stop5.setAttribute('style', 'stop-color:#ffd700');

            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            gradient.appendChild(stop3);
            gradient.appendChild(stop4);
            gradient.appendChild(stop5);
            defs.appendChild(gradient);
            svg.appendChild(defs);

            // Add area fill
            const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            areaPath.setAttribute('d', `${pathData} L 1000 300 L 0 300 Z`);
            areaPath.setAttribute('fill', 'url(#lineGradient)');
            areaPath.setAttribute('opacity', '0.2');
            svg.appendChild(areaPath);

            // Add temperature line
            const linePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            linePath.setAttribute('d', pathData);
            linePath.setAttribute('stroke', 'url(#lineGradient)');
            linePath.setAttribute('stroke-width', '3');
            linePath.setAttribute('fill', 'none');
            linePath.setAttribute('stroke-linecap', 'round');
            linePath.setAttribute('stroke-linejoin', 'round');
            svg.appendChild(linePath);

            // Add data points
            points.forEach((point, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                
                if (index === 7) {
                    // Today's point
                    circle.setAttribute('r', '8');
                    circle.setAttribute('fill', '#e94560');
                    circle.setAttribute('class', 'data-point current-point');
                    
                    // Add pulse ring
                    const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    ring.setAttribute('cx', point.x);
                    ring.setAttribute('cy', point.y);
                    ring.setAttribute('r', '12');
                    ring.setAttribute('fill', '#e94560');
                    ring.setAttribute('opacity', '0.3');
                    ring.setAttribute('class', 'pulse-ring');
                    svg.appendChild(ring);
                } else if (index < 7) {
                    // Past points
                    circle.setAttribute('r', '5');
                    circle.setAttribute('fill', '#6b7280');
                    circle.setAttribute('class', 'data-point past-point');
                } else {
                    // Future points
                    circle.setAttribute('r', '5');
                    circle.setAttribute('fill', '#00d9ff');
                    circle.setAttribute('class', 'data-point future-point');
                }
                
                svg.appendChild(circle);
            });

            // Generate labels
            labelsContainer.innerHTML = '';
            
            const dates = [
                ...weatherData.historical.time.slice(-7),
                ...weatherData.forecast.time.slice(0, 8)
            ];

            const weatherCodes = [
                ...weatherData.historical.weather_code.slice(-7),
                ...weatherData.forecast.weather_code.slice(0, 8)
            ];

            const precipProbs = [
                ...(weatherData.historical.precipitation_probability_max?.slice(-7) || Array(7).fill(null)),
                ...(weatherData.forecast.precipitation_probability_max?.slice(0, 8) || Array(8).fill(null))
            ];

            allTemps.forEach((temp, index) => {
                const date = new Date(dates[index]);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const weather = getWeatherEmoji(weatherCodes[index]);
                const precip = precipProbs[index];

                const label = document.createElement('div');
                label.className = 'day-label';
                
                if (index === 7) {
                    label.classList.add('current-label');
                } else if (index < 7) {
                    label.classList.add('past-label');
                } else {
                    label.classList.add('future-label');
                }

                label.innerHTML = `
                    <div class="label-temp">${Math.round(temp)}¬∞F</div>
                    <div class="label-day">${index === 7 ? '<strong>TODAY</strong>' : dayName}<br>${monthDay}</div>
                    <div class="label-icon">${weather.emoji} ${precip ? precip + '%' : ''}</div>
                `;
                
                labelsContainer.appendChild(label);
            });

            // Update last updated time
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                `Last updated: ${now.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                })}`;
        }

        // Initialize map
        function initializeMap() {
            try {
                weatherMap = L.map('weatherMap').setView([LATITUDE, LONGITUDE], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(weatherMap);
                
                // Add precipitation layer from OpenWeatherMap
                const apiKey = 'f9e35e302c3c0b1f7f3c3e3a3e3b3c3d';
                L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${apiKey}`, {
                    attribution: 'Weather data ¬© OpenWeatherMap',
                    opacity: 0.6,
                    maxZoom: 19
                }).addTo(weatherMap);
                
                L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${apiKey}`, {
                    attribution: 'Weather data ¬© OpenWeatherMap',
                    opacity: 0.4,
                    maxZoom: 19
                }).addTo(weatherMap);
                
                L.marker([LATITUDE, LONGITUDE])
                    .addTo(weatherMap)
                    .bindPopup('<b>üìç Ladue, MO</b><br>Live Weather Data')
                    .openPopup();
                
                setTimeout(() => {
                    weatherMap.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        // Load everything on page load
        window.addEventListener('load', () => {
            fetchWeatherData();
            setTimeout(initializeMap, 500);
        });

        // Auto-refresh every 30 minutes
        setInterval(fetchWeatherData, 30 * 60 * 1000);
    </script>
</body>
</html>
